# Story 1.1: AI Training Plan Generation and Management

## Status

Ready

## Story

**As a** user of the AI Training Companion,
**I want** to generate and manage personalized multi-week training plans,
**so that** I have a structured, AI-driven roadmap for my fitness journey that adapts to my goals, experience level, and schedule.

## Acceptance Criteria

1. **Plan Generation - Onboarding**
   - During onboarding, after profile creation, user is prompted to generate their first training plan
   - Plan generation uses user profile data: goals, experience level, preferred training days, equipment, injuries
   - AI determines appropriate plan duration (number of weeks) based on fitness level and goals
   - Generated plan maps each preferred training day to specific training focus/modality
   - Plan supports mixed modalities per day (e.g., "Chest + Cardio")
   - Plan is automatically set as the active plan after generation
   - User can proceed to home page after plan generation completes

2. **Plan Generation - Post-Onboarding**
   - If user has no active plan, home page displays "Generate Plan" button
   - User can access "Manage Plans" from home page at any time
   - Dedicated plan management page allows generating new plans
   - Plan generation is always user-initiated (never automatic)
   - Each plan generation creates a new stored plan in the database

3. **Plan Storage & Persistence**
   - Generated plans are stored in database with full plan details
   - Each plan includes: plan ID, user ID, duration (weeks), weekly schedule, creation date, active status
   - Weekly schedule stores day-to-modality mapping (e.g., Mon: "Chest", Tue: "Back+Cardio", Wed: "Rest")
   - Plans persist across sessions and devices

4. **Active Plan Management**
   - User can have multiple stored plans but only one active plan at a time
   - User can switch active plan from plan management page
   - Switching active plan is allowed mid-cycle (doesn't require completing current plan)
   - Setting a plan as active immediately makes it the source for session generation
   - Active plan is clearly indicated in UI

5. **Plan Deletion**
   - User can delete any non-active plan from plan management page
   - Deleting active plan requires user to select a different plan as active first, or confirms they want no active plan
   - Deletion is permanent with confirmation dialog

6. **Plan Viewing**
   - User can view full details of any stored plan (active or inactive)
   - Plan view shows: duration, weekly schedule with day-to-modality mapping, creation date
   - Active plan is displayed on home page with current week highlighted

7. **Plan Independence from Session Feedback**
   - High-level training plan structure remains unchanged by individual session feedback
   - Session feedback only affects future session generation (exercise selection, load progression)
   - Plan does not auto-adapt or regenerate based on performance

8. **API & Data Validation**
   - API endpoint(s) for plan generation accept user profile and return generated plan
   - AI response validated with Zod schema before persisting
   - Plan generation includes retry logic for AI failures
   - RLS enforces user can only access their own plans

## Tasks / Subtasks

- [ ] **Task 1: Database Schema & Migrations** (AC: 3, 8)
  - [ ] Create `training_plans` table with columns: id, user_id, name, duration_weeks, weekly_schedule (JSONB), is_active, created_at, updated_at
  - [ ] Add RLS policies: users can only CRUD their own plans
  - [ ] Create migration file using Drizzle
  - [ ] Apply migration to Supabase

- [ ] **Task 2: API - Plan Generation** (AC: 1, 2, 8)
  - [ ] Implement API endpoint(s) for plan generation
  - [ ] Define Zod schema for AI plan generation response
  - [ ] Implement Cloudflare Workers AI call with prompt engineering for plan generation
  - [ ] Parse and validate AI response
  - [ ] Store generated plan in database
  - [ ] Return plan data to client

- [ ] **Task 3: API - Plan Management** (AC: 4, 5, 8)
  - [ ] Implement API endpoint(s) for fetching user plans
  - [ ] Implement API endpoint(s) for fetching single plan details
  - [ ] Implement API endpoint(s) for updating plan (set active)
  - [ ] Implement API endpoint(s) for deleting plan
  - [ ] Implement RLS enforcement in all endpoints

- [ ] **Task 4: Pinia Store - Plans** (AC: 3, 4, 5, 6)
  - [ ] Create `stores/plans.ts`
  - [ ] State: plans array, activePlan, loading, error
  - [ ] Actions: fetchPlans, generatePlan, setActivePlan, deletePlan
  - [ ] Computed: activePlanDetails, inactivePlans

- [ ] **Task 5: UI Component - Plan Generation** (AC: 1, 2)
  - [ ] Create `components/plans/PlanGenerator.vue`
  - [ ] Loading state during AI generation
  - [ ] Success state with plan preview
  - [ ] Error handling with retry option
  - [ ] Mobile-first design with large tap targets

- [ ] **Task 6: UI Component - Plan Card** (AC: 6)
  - [ ] Create `components/plans/PlanCard.vue`
  - [ ] Display plan name, duration, creation date
  - [ ] Show weekly schedule grid
  - [ ] Active/inactive badge
  - [ ] Actions: view details, set active, delete

- [ ] **Task 7: Page - Plan Management** (AC: 2, 4, 5, 6)
  - [ ] Create `pages/plans/index.vue`
  - [ ] List all user plans (active first)
  - [ ] "Generate New Plan" button
  - [ ] Plan cards with management actions
  - [ ] Confirmation dialogs for destructive actions

- [ ] **Task 8: Onboarding Integration** (AC: 1)
  - [ ] Update `pages/onboarding.vue` to include plan generation as final step
  - [ ] Show plan generation UI after profile creation
  - [ ] Auto-set generated plan as active
  - [ ] Navigate to home page after completion

- [ ] **Task 9: Home Page Integration** (AC: 2, 6)
  - [ ] Update `pages/index.vue` to display active plan
  - [ ] Show "Generate Plan" button if no active plan
  - [ ] Show "Manage Plans" button
  - [ ] Display current week of active plan
  - [ ] Link to plan management page

- [ ] **Task 10: Testing & Validation** (AC: All)
  - [ ] Test plan generation with various user profiles
  - [ ] Test plan switching and deletion
  - [ ] Verify RLS policies work correctly
  - [ ] Test error handling and retry logic
  - [ ] Validate mobile responsiveness

## Dev Notes

### Database Schema

```typescript
// training_plans table
{
  id: uuid (PK),
  user_id: uuid (FK to auth.users),
  name: string (AI-generated or user-editable),
  duration_weeks: integer,
  weekly_schedule: jsonb, // { week1: { Mon: "Chest", Tue: "Back+Cardio", ... }, week2: {...} }
  is_active: boolean (default false),
  created_at: timestamp,
  updated_at: timestamp
}
```

### AI Prompt Structure

The AI prompt for plan generation should include:

- User goals (comma-separated string)
- Experience level (beginner/intermediate/advanced)
- Preferred training days (array of day abbreviations)
- Available equipment (from profile)
- Injury flags (if any)
- Request for: plan duration, weekly schedule with **high-level** modality assignments

**Important**: The plan should remain high-level - only training focus/modality per day (e.g., "Chest", "Back+Cardio", "Rest"). No specific exercises, sets, reps, or weights. Detailed session content is generated separately via AI Session Generation.

### Zod Schema Example

```typescript
const TrainingPlanSchema = z.object({
  name: z.string(),
  duration_weeks: z.number().int().min(1).max(52),
  weekly_schedule: z.record(
    z.string(), // week key: "week1", "week2", etc.
    z.record(
      z.enum(['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']),
      z.string() // modality: "Chest", "Rest", "Cardio+Core", etc.
    )
  ),
})
```

### Tech Stack

- **Framework**: Nuxt 4 (Vue 3 + TypeScript)
- **UI**: PrimeVue components (Card, Button, Dialog, DataView)
- **State**: Pinia store
- **Database**: Supabase Postgres with RLS
- **ORM**: Drizzle ORM
- **AI**: Cloudflare Workers AI (`@cf/meta/llama-4-scout-17b-16e-instruct`)
- **Validation**: Zod

### Component Organization

```
components/
  plans/
    PlanGenerator.vue      # Plan generation UI
    PlanCard.vue          # Display single plan
    PlanWeekView.vue      # Weekly schedule grid
pages/
  plans/
    index.vue             # Plan management page
stores/
  plans.ts                # Plans Pinia store
server/
  api/
    plans/
      # API structure to be determined by developer
      # Required operations: generate, list, get, update, delete
```

### Design Tokens

Use existing design tokens from `main.css`:

- Spacing: `--spacing-xs` to `--spacing-xl`
- Colors: `--p-primary-color`, `--p-surface-*`, `--p-text-color`
- All units in `rem` (no `px`)

### Testing

#### Unit Tests (Vitest)

- Test Pinia store actions and computed properties
- Test Zod schema validation
- Test API endpoint logic

#### Integration Tests

- Test plan generation flow end-to-end
- Test plan switching and deletion
- Test RLS policies

#### Manual Testing Checklist

- [ ] Generate plan during onboarding
- [ ] Generate additional plans post-onboarding
- [ ] Switch active plan
- [ ] Delete inactive plan
- [ ] Attempt to delete active plan (should require confirmation)
- [ ] View plan details
- [ ] Verify mobile responsiveness
- [ ] Test with various user profiles (beginner, intermediate, advanced)

## Change Log

| Date       | Version | Description            | Author     |
| ---------- | ------- | ---------------------- | ---------- |
| 2025-10-22 | 1.0     | Initial story creation | Sarah (PO) |

## Dev Agent Record

_(This section will be populated by the development agent during implementation)_

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results

_(This section will be populated by the QA agent after implementation)_
